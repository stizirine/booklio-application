services:
  # --- FRONTEND (Point d'entrée unique) ---
  frontend:
    build:
      context: ./frontend
      args:
        # Variables d'environnement pour le build React
        - REACT_APP_API_BASE_URL=${REACT_APP_API_BASE_URL:-/api}
        - REQUIRED_HEADER_NAME=${REQUIRED_HEADER_NAME:-x-api-key}
        - REQUIRED_HEADER_VALUE=${REQUIRED_HEADER_VALUE:-}
        - NODE_ENV=production
    container_name: booklio-frontend
    restart: always
    volumes:
      # Monter nginx.conf pour pouvoir le modifier sans rebuild
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - booklio-backend
    ports:
      - "8080:80"
    networks:
      - booklio-network
  # --- BACKEND (Caché derrière le front) ---
  booklio-backend:
    build: ./backend
    container_name: booklio-api
    restart: always
    env_file:
      - .env
    depends_on:
      - mongo
      - redis
    environment:
      - NODE_ENV=${NODE_ENV}
      - PORT=${PORT}
      - BCRYPT_SALT_ROUNDS=${BCRYPT_SALT_ROUNDS}
      # Connexion Mongo (l'entrypoint construit MONGO_URI si absent)
      - MONGO_PASSWORD=${MONGO_PASSWORD}
      - MONGO_URI=${MONGO_URI:-}
      - MONGO_HOST=${MONGO_HOST:-mongo}
      - MONGO_PORT=${MONGO_PORT:-27017}
      - MONGO_USER=${MONGO_USER:-booklio}
      - MONGO_DB=${MONGO_DB:-booklio}
      - MONGO_AUTH_SOURCE=${MONGO_AUTH_SOURCE:-admin}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      # Variables secrètes injectées
      - JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      # Configuration API Key Header (optionnel)
      - REQUIRED_HEADER_NAME=${REQUIRED_HEADER_NAME:-x-api-key}
      - REQUIRED_HEADER_VALUE=${REQUIRED_HEADER_VALUE:-}
    networks:
      - booklio-network
    # Port exposé en dev pour accéder directement au backend
    ports:
      - "4000:4000"

  # --- BASE DE DONNÉES ---
  mongo:
    image: mongo:7
    container_name: booklio-mongo
    restart: always
    environment:
      - MONGO_INITDB_ROOT_USERNAME=booklio
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASSWORD}
    ports:
      - '27017:27017'
    volumes:
      - mongo-data:/data/db
    networks:
      - booklio-network

  redis:
    image: redis:7-alpine
    container_name: booklio-redis
    restart: always
    networks:
      - booklio-network

  # --- MONITORING (Optionnel) ---
  prometheus:
    image: prom/prometheus:latest
    container_name: booklio-prometheus
    restart: unless-stopped
    volumes:
      - ./backend/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    networks:
      - booklio-network

  grafana:
    image: grafana/grafana:latest
    container_name: booklio-grafana
    restart: unless-stopped
    ports:
      - '3000:3000' # Accessible via http://ton-ip:3000
    volumes:
      - grafana-data:/var/lib/grafana
    networks:
      - booklio-network

networks:
  booklio-network:
    driver: bridge

volumes:
  mongo-data:
  prometheus-data:
  grafana-data: